#!/usr/bin/env python3
"""Voxtype recording indicator for KDE Plasma.

Provides a system tray icon that shows voxtype state:
gray = idle, red = recording, blue = transcribing.
"""

import os
import signal
import sys
from pathlib import Path

from PyQt6.QtCore import Qt, QTimer, QFileSystemWatcher
from PyQt6.QtGui import QIcon, QPainter, QColor, QPixmap, QPen
from PyQt6.QtWidgets import (
    QApplication,
    QMenu,
    QSystemTrayIcon,
)

STATE_FILE = Path(
    os.environ.get("XDG_RUNTIME_DIR", f"/run/user/{os.getuid()}")
) / "voxtype" / "state"

COLORS = {
    "idle": QColor(100, 100, 100),
    "recording": QColor(220, 40, 40),
    "transcribing": QColor(60, 140, 220),
}


def _read_state_file():
    """Read the voxtype state file safely with bounded read."""
    try:
        with open(STATE_FILE, "r", errors="replace") as f:
            state = f.read(64).strip()
    except OSError:
        return "idle"
    return state if state in COLORS else "idle"


def make_tray_icon(state: str, size: int = 64) -> QIcon:
    pixmap = QPixmap(size, size)
    pixmap.fill(Qt.GlobalColor.transparent)
    painter = QPainter(pixmap)
    painter.setRenderHint(QPainter.RenderHint.Antialiasing)
    color = COLORS.get(state, COLORS["idle"])
    painter.setBrush(color)
    painter.setPen(QPen(color.darker(120), 2))
    margin = 6
    painter.drawEllipse(margin, margin, size - 2 * margin, size - 2 * margin)
    if state == "recording":
        painter.setBrush(QColor(255, 255, 255))
        painter.setPen(Qt.PenStyle.NoPen)
        inner = size // 4
        painter.drawEllipse(
            size // 2 - inner // 2, size // 2 - inner // 2, inner, inner
        )
    elif state == "transcribing":
        painter.setPen(QPen(QColor(255, 255, 255), 3))
        cx, cy = size // 2, size // 2
        r = size // 6
        for i in range(3):
            x = cx - r + i * r
            painter.drawPoint(x, cy)
    painter.end()
    return QIcon(pixmap)


class VoxtypeIndicator:
    def __init__(self):
        self.app = QApplication(sys.argv)
        self.app.setApplicationName("voxtype-indicator")
        self.app.setQuitOnLastWindowClosed(False)

        self._state = "idle"
        self._watcher_ready = False

        # System tray
        self.tray = QSystemTrayIcon(make_tray_icon("idle"), self.app)
        self.tray.setToolTip("Voxtype")
        menu = QMenu()
        menu.addAction("Quit", self.app.quit)
        self.tray.setContextMenu(menu)
        self.tray.show()

        # Fallback poll â€” starts at 500ms, reduced to 2s once watchers are up
        self._poll_timer = QTimer()
        self._poll_timer.timeout.connect(self._poll_state)

        # Watch state file (must be after _poll_timer creation)
        self.watcher = QFileSystemWatcher()
        self._setup_watcher()
        self.watcher.fileChanged.connect(self._on_state_changed)
        self.watcher.directoryChanged.connect(self._on_dir_changed)

        self._poll_timer.start(500 if not self._watcher_ready else 2000)

        self._read_state()

    def _setup_watcher(self):
        registered = False
        if STATE_FILE.exists():
            if str(STATE_FILE) not in self.watcher.files():
                if self.watcher.addPath(str(STATE_FILE)):
                    registered = True
            else:
                registered = True
        if STATE_FILE.parent.exists():
            if str(STATE_FILE.parent) not in self.watcher.directories():
                if self.watcher.addPath(str(STATE_FILE.parent)):
                    registered = True
            else:
                registered = True
        if registered and not self._watcher_ready:
            self._watcher_ready = True
            self._poll_timer.setInterval(2000)

    def _on_dir_changed(self, path):
        if STATE_FILE.exists() and str(STATE_FILE) not in self.watcher.files():
            self.watcher.addPath(str(STATE_FILE))
        self._read_state()

    def _on_state_changed(self, path):
        if STATE_FILE.exists() and str(STATE_FILE) not in self.watcher.files():
            self.watcher.addPath(str(STATE_FILE))
        self._read_state()

    def _poll_state(self):
        if not self._watcher_ready:
            self._setup_watcher()
        self._read_state()

    def _read_state(self):
        state = _read_state_file()
        if state != self._state:
            self._state = state
            self.tray.setIcon(make_tray_icon(state))

    def run(self):
        signal.signal(signal.SIGINT, signal.SIG_DFL)
        signal.signal(signal.SIGTERM, signal.SIG_DFL)
        sys.exit(self.app.exec())


if __name__ == "__main__":
    VoxtypeIndicator().run()
